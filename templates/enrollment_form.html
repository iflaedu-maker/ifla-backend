{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment Form - IFLA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <style>
        body {
            background: #0F0F14;
            min-height: 100vh;
            color: #fff;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background Gradient - matching hero section */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 20% 50%, rgba(88, 86, 214, 0.12) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 107, 107, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(58, 123, 213, 0.1) 0%, transparent 50%);
            z-index: 1;
            pointer-events: none;
        }
        
        /* Grid Overlay - matching hero section */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 80px 80px;
            z-index: 2;
            mask-image: radial-gradient(ellipse 100% 100% at 50% 50%, black 40%, transparent 100%);
            pointer-events: none;
        }
        
        /* Navbar should match main page */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background-color: transparent;
            backdrop-filter: none;
        }
        
        .enrollment-container {
            position: relative;
            z-index: 10;
            max-width: 900px;
            margin: 120px auto 60px;
            padding: 40px;
            background: rgba(15, 15, 20, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
        }
        
        .enrollment-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .enrollment-title {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #fff 0%, #5856D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }
        
        .enrollment-subtitle {
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            color: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-left">
            <button class="hamburger-menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="logo">IFLA</div>
        </div>
        <div class="nav-center">
            <div class="nav-links">
                <a href="{% url 'index' %}" class="nav-link">Home</a>
                <a href="{% url 'languages' %}" class="nav-link">Courses / Languages</a>
                <a href="#" class="nav-link">About Us</a>
                <a href="{% url 'index' %}#contact" class="nav-link">Contact</a>
            </div>
        </div>
        <div class="nav-right">
            {% if user.is_authenticated %}
                <a href="{% url 'dashboard' %}" class="nav-btn nav-btn-login">Dashboard</a>
                <a href="{% url 'logout_redirect' %}" class="nav-btn nav-btn-signup">Logout</a>
            {% else %}
                <a href="{% url 'auth' %}" class="nav-btn nav-btn-login">Login</a>
                <a href="{% url 'auth' %}?action=signup" class="nav-btn nav-btn-signup">Sign Up</a>
            {% endif %}
        </div>
    </nav>

    <div class="enrollment-container">
        <div class="enrollment-header">
            <h1 class="enrollment-title">Course Enrollment Application</h1>
            <p class="enrollment-subtitle">Please fill out all the required information to complete your enrollment</p>
        </div>

        {% include 'enrollment_form_content.html' %}
    </div>

    <script>
        // Language data from Django
        const languagesData = {
            {% for lang in languages %}
            "{{ lang.id }}": {
                name: "{{ lang.name }}",
                levels: [
                    {% for level in lang.levels.all %}
                    {
                        id: {{ level.id }},
                        level: "{{ level.level }}",
                        display: "{{ level.get_level_display }}",
                        price: {{ level.price }}
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        // Handle language selection
        const languageSelect = document.getElementById('language');
        const levelsContainer = document.getElementById('levelsContainer');
        const levelCheckboxes = document.getElementById('levelCheckboxes');
        const totalAmountContainer = document.getElementById('totalAmountContainer');
        const totalAmountSpan = document.getElementById('totalAmount');

        languageSelect.addEventListener('change', function() {
            const languageId = this.value;
            
            if (languageId && languagesData[languageId]) {
                const levels = languagesData[languageId].levels;
                
                // Clear previous level options
                levelCheckboxes.innerHTML = '';
                
                // Check if levels exist
                if (levels && levels.length > 0) {
                    // Create checkbox for each level
                    levels.forEach(level => {
                        // Ensure price is a number
                        const price = parseFloat(level.price) || 0;
                        const formattedPrice = price > 0 ? price.toLocaleString('en-IN') : '0';
                        
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <input type="checkbox" id="level_${level.id}" name="levels" 
                                   value="${level.id}" class="enrollment-level-checkbox" data-price="${price}">
                            <label for="level_${level.id}" class="enrollment-level-label">
                                <span class="enrollment-level-name">${level.display}</span>
                                <span class="enrollment-level-price">â‚¹${formattedPrice}</span>
                            </label>
                        `;
                        levelCheckboxes.appendChild(div);
                    });
                    
                    levelsContainer.style.display = 'block';
                    
                    // Add event listeners to checkboxes for total calculation
                    document.querySelectorAll('.enrollment-level-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', calculateTotal);
                    });
                } else {
                    // No levels available
                    levelCheckboxes.innerHTML = '<p style="color: rgba(255,255,255,0.7); padding: 20px; text-align: center;">No course levels available for this language yet.</p>';
                    levelsContainer.style.display = 'block';
                    totalAmountContainer.style.display = 'none';
                }
            } else {
                levelsContainer.style.display = 'none';
                totalAmountContainer.style.display = 'none';
            }
        });

        // Calculate total amount
        function calculateTotal() {
            const checkedBoxes = document.querySelectorAll('.enrollment-level-checkbox:checked');
            let total = 0;
            
            checkedBoxes.forEach(checkbox => {
                const price = parseFloat(checkbox.dataset.price) || 0;
                total += price;
            });
            
            if (checkedBoxes.length > 0) {
                totalAmountSpan.textContent = total.toLocaleString('en-IN');
                totalAmountContainer.style.display = 'block';
            } else {
                totalAmountContainer.style.display = 'none';
            }
        }

        // Handle file uploads
        const photoInput = document.getElementById('photo');
        const photoLabel = document.getElementById('photoLabel');
        const verificationInput = document.getElementById('verification_document');
        const verificationLabel = document.getElementById('verificationLabel');
        const signatureInput = document.getElementById('signature');
        const signatureLabel = document.getElementById('signatureLabel');

        if (photoInput && photoLabel) {
            photoInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    photoLabel.classList.add('has-file');
                    photoLabel.querySelector('.enrollment-file-text').textContent = this.files[0].name;
                }
            });
        }

        if (verificationInput && verificationLabel) {
            verificationInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    verificationLabel.classList.add('has-file');
                    verificationLabel.querySelector('.enrollment-file-text').textContent = this.files[0].name;
                }
            });
        }

        if (signatureInput && signatureLabel) {
            signatureInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    signatureLabel.classList.add('has-file');
                    signatureLabel.querySelector('.enrollment-file-text').textContent = this.files[0].name;
                }
            });
        }

        // Form validation
        document.getElementById('enrollmentForm').addEventListener('submit', function(e) {
            const checkedLevels = document.querySelectorAll('.enrollment-level-checkbox:checked');
            
            if (checkedLevels.length === 0) {
                e.preventDefault();
                alert('Please select at least one course level');
                return false;
            }
        });

        // Trigger language selection if pre-selected (with delay to ensure DOM is ready)
        setTimeout(() => {
            if (languageSelect && languageSelect.value) {
                console.log('Pre-selected language ID:', languageSelect.value);
                const changeEvent = new Event('change', { bubbles: true });
                languageSelect.dispatchEvent(changeEvent);
            } else {
                // Check URL parameters as fallback
                const urlParams = new URLSearchParams(window.location.search);
                const langParam = urlParams.get('language') || urlParams.get('language_id');
                if (langParam && !languageSelect.value) {
                    console.log('Language parameter found but not selected:', langParam);
                    const options = languageSelect.querySelectorAll('option');
                    for (let option of options) {
                        if (option.textContent.includes(langParam) || option.value === langParam) {
                            languageSelect.value = option.value;
                            const changeEvent = new Event('change', { bubbles: true });
                            languageSelect.dispatchEvent(changeEvent);
                            console.log('Manually selected language:', option.value, option.textContent);
                            break;
                        }
                    }
                }
            }
        }, 200);
    </script>
</body>
</html>

